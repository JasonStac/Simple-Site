<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/styles/navigation-bar.css">
  <link rel="stylesheet" href="https://unpkg.com/@yaireo/tagify/dist/tagify.css">
  <title>Starting for image board</title>
</head>

<body>
  <div class="topnav">
    <div class="left">
      <a href="/">Home</a>
      <a href="/view/posts">View</a>
      <a href="/view/tags">Tags</a>
      <a href="/view/people">People</a>
    </div>
    <div class="right">
      <a href="/logout">Logout</a>
      <a href="/profile">Profile</a>
    </div>
  </div>

  <h1>Adding Content</h1>

  <form action="/profile/create" method="POST" enctype="multipart/form-data" name="inputForm" id="inputForm">
    <label for="title">Title: </label>
    <textarea id="title" name="title" rows="1" cols="30"></textarea><br />

    <label for="mediaSelect">Type: </label>
    <select id="mediaSelect" name="media">
      {{range .MediaTypes}}
        <option value="{{.}}">{{.}}</option>
      {{end}}
    </select><br />

    <label for="file">File: </label>
    <input id="file" name="file" type="file"/><br /><br /><br />

    <label for="peopleSelect">People: </label>
    <input id="peopleSelect" name="people"><br />

    <label for="tagSelect">Tags: </label>
    <input id="tagSelect" name="tags"><br />

    <br />

    <button type="submit">Save</button>
  </form>

  <p id="error" style="color: red; font-weight: bold;"></p>

  <script src="https://unpkg.com/@yaireo/tagify"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const peopleList = [
        {{- range .PeopleList }}
        { id: {{.ID}}, value: "{{.Name}}" },
        {{- end }}
      ];

      const tagList = [
        {{- range .TagList }}
        { id: {{.ID}}, value: "{{.Name}}" },
        {{- end }}
      ];

      new Tagify(document.querySelector('#peopleSelect'), {
        whitelist: peopleList,
        enforceWhitelist: false,
        dropdown: {
          enabled: 0,
          maxItems: 20
        },
        transformTag: (tagData) => {
          tagData.type = "{{.PeopleTag}}";
          return tagData;
        }
      });

      new Tagify(document.querySelector('#tagSelect'), {
        whitelist: tagList,
        enforcedWhitelist: false,
        dropdown: {
          enabled: 0,
          maxItems: 20
        },
        transformTag: (tagData) => {
          tagData.type = "{{.GeneralTag}}";
          return tagData;
        }
      });
    });

    const form = document.getElementById("inputForm");
    const errorDisplay = document.getElementById("error");

    form.addEventListener("submit", function(e) {
      errorDisplay.textContent = "";

      const acceptedMediaExtensions = new Map([
        ["{{.TypeImage}}", {{.ImageExts}}],
        ["{{.TypeVideo}}", {{.VideoExts}}],
        ["{{.TypeAudio}}", {{.AudioExts}}]
      ]);

      const mediaOptions = document.getElementById("mediaSelect")
      const selectedIndex = mediaOptions.selectedIndex;
      if (selectedIndex === -1) {
        errorDisplay.textContent = "Please select a media type";
        e.preventDefault();
        return
      }

      const mediaType = mediaOptions.options[selectedIndex].value;
      allowedExts = acceptedMediaExtensions.get(mediaType);
      fileExt = getFileExtension();
      if (!allowedExts.includes(fileExt)) {
        errorDisplay.textContent = "File extension not supported for chosen media type";
        e.preventDefault();
        return
      }
    });

    function getFileExtension() {
      let ext = ""
      const fileInput = document.getElementById("file").files;
      if (fileInput.length > 0) {
        const file = fileInput[0];
        const filename = file.name;

        const lastDotIndex = filename.lastIndexOf(".");
        if (lastDotIndex !== -1 && lastDotIndex < filename.length - 1) {
          ext = filename.substring(lastDotIndex);
        }
      }
      return ext
    }
  </script>
</body>
</html>